# CodeRabbitレビュー修正（/coderabbit-fix）

CodeRabbitのレビューコメントを確認し、ユーザーの承認を得てから修正を実装するコマンドです。

## 目的

CodeRabbitが指摘した内容を、ユーザーの判断で選択的に修正する。

## 引数

- `$ARGUMENTS` (必須): 対象のPR番号
  - 番号のみ: `39`
  - URL形式: `https://github.com/owner/repo/pull/39`

## 振る舞い

### 1. CodeRabbitレビューの取得

1. `gh pr view {PR番号} --comments --json comments` でCodeRabbitのコメントを取得
2. CodeRabbitからのコメントのみを抽出（`author.login == "coderabbitai"`）
3. レビュー内容を解析し、以下のカテゴリに分類：
   - **セキュリティ（Security）**: 脆弱性、セキュリティリスク
   - **バグ（Bug）**: 潜在的なバグ、ロジックエラー
   - **パフォーマンス（Performance）**: パフォーマンス改善提案
   - **コードスタイル（Style）**: コーディング規約、フォーマット
   - **ベストプラクティス（Best Practice）**: 設計改善、リファクタリング提案
   - **ドキュメント（Documentation）**: コメント、ドキュメント不足
   - **その他（Other）**: 上記に該当しない提案

### 2. レビュー内容の表示とユーザー確認

1. カテゴリごとにレビュー内容を整理して表示
2. 各カテゴリの指摘件数を表示
3. **ユーザーに質問**：「どのカテゴリの指摘を修正しますか？」
   - 選択肢：
     - すべて修正
     - セキュリティとバグのみ（推奨）
     - カテゴリを選択して修正
     - 個別に選択して修正
     - 修正しない（キャンセル）

### 3. 修正の実装

1. ユーザーが承認した指摘のみを対象に修正を実装
2. **現在のブランチで直接コミット**（新しいブランチは作成しない）
3. 修正内容を明確にしたコミットメッセージを作成
   - 形式: `fix: CodeRabbitレビュー対応 - {カテゴリ名}`
   - 例: `fix: CodeRabbitレビュー対応 - セキュリティ、バグ`
4. コミットしてPRにプッシュ

### 4. CodeRabbitへの通知（オプション）

修正完了後、CodeRabbitに対して以下のコメントを投稿（オプション）：
- `@coderabbitai: 指摘内容を修正しました。再度レビューをお願いします。`

## 出力フォーマット

```markdown
## CodeRabbitレビュー分析結果

### カテゴリ別指摘件数
- セキュリティ: {件数}
- バグ: {件数}
- パフォーマンス: {件数}
- コードスタイル: {件数}
- ベストプラクティス: {件数}
- ドキュメント: {件数}
- その他: {件数}

### 詳細

#### セキュリティ
- {ファイルパス}: {指摘内容の要約}

#### バグ
- {ファイルパス}: {指摘内容の要約}

（以下同様）

---

## ユーザー確認

どのカテゴリの指摘を修正しますか？
1. すべて修正
2. セキュリティとバグのみ（推奨）
3. カテゴリを選択して修正
4. 個別に選択して修正
5. 修正しない（キャンセル）
```

## 修正完了後の報告

```markdown
## 修正完了報告

### 対応したレビュー指摘
- [x] セキュリティ: {件数}件修正
- [x] バグ: {件数}件修正
- [ ] パフォーマンス: 修正不要と判断
- [x] コードスタイル: {件数}件修正

### コミット情報
- コミットハッシュ: {hash}
- コミットメッセージ: {message}
- 変更ファイル: {ファイルリスト}

### 未対応の指摘（ユーザーが対応不要と判断）
- パフォーマンス: {理由}
- その他: {理由}
```

## 制約（重要）

- **ユーザーが承認した指摘のみ修正する**
- **CodeRabbitのコメントのみを対象とする**（人間のレビューは対象外）
- **既存のPRブランチで修正する**（新しいブランチは作成しない）
- **修正が大規模になる場合は警告し、ユーザーに確認する**
- **修正内容が不明瞭な場合は、ユーザーに質問して確認する**

## 使用例

```bash
# PR番号を指定してCodeRabbitレビューを修正
/coderabbit-fix 39

# URL形式でも可
/coderabbit-fix https://github.com/okazuki58/dandori/pull/39
```

## オプション機能（将来拡張）

以下の機能は将来的に追加可能：

- `--auto-apply minor`: マイナーな指摘（スタイル、タイポ）は自動修正
- `--interactive`: 対話的に1つずつ確認しながら修正
- `--category security,bug`: 特定カテゴリのみ修正
- `--dry-run`: 修正内容をプレビューのみ（実際には修正しない）

## 前提条件

- GitHub CLI (`gh`) がインストールされ、認証済みであること
- 対象PRが存在し、CodeRabbitがレビュー済みであること
- 現在のディレクトリが対象リポジトリのワーキングディレクトリであること
- 修正対象のブランチにチェックアウトされていること

## エラーハンドリング

### CodeRabbitのコメントが見つからない場合

「PR #{番号} にCodeRabbitのレビューコメントが見つかりませんでした。」と表示してコマンドを終了。

### PRが存在しない場合

「PR #{番号} が見つかりませんでした。PR番号を確認してください。」と表示してコマンドを終了。

### 修正中にエラーが発生した場合

1. エラー内容を表示
2. 部分的に修正済みの内容を報告
3. ユーザーに次のアクションを提案（手動修正、再試行、ロールバック）

## セキュリティ上の注意

- CodeRabbitの指摘を盲目的に信頼しない
- セキュリティ関連の修正は特に慎重に確認する
- 修正内容が意図しない副作用を持たないか検証する

## 推奨ワークフロー

1. PRを作成する
2. CodeRabbitのレビューを待つ（数分）
3. `/coderabbit-fix {PR番号}` を実行
4. レビュー内容を確認し、修正するカテゴリを選択
5. 修正が完了したら、再度CodeRabbitのレビューを確認
6. 必要に応じて手動で追加修正
7. PRをマージ

## 関連コマンド

- `/issue-run`: GitHub Issueの実装
- `/pr`: プルリクエスト作成
